<!DOCTYPE html>

<html>
<head>
  <title>leads.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="__init__.html">
                __init__.py
              </a>
            
              
              <a class="source" href="base.html">
                base.py
              </a>
            
              
              <a class="source" href="blog.html">
                blog.py
              </a>
            
              
              <a class="source" href="broadcast.html">
                broadcast.py
              </a>
            
              
              <a class="source" href="error.html">
                error.py
              </a>
            
              
              <a class="source" href="forms.html">
                forms.py
              </a>
            
              
              <a class="source" href="keywords.html">
                keywords.py
              </a>
            
              
              <a class="source" href="leads.html">
                leads.py
              </a>
            
              
              <a class="source" href="logging_helper.html">
                logging_helper.py
              </a>
            
              
              <a class="source" href="nurturing.html">
                nurturing.py
              </a>
            
              
              <a class="source" href="prospects.html">
                prospects.py
              </a>
            
              
              <a class="source" href="settings.html">
                settings.py
              </a>
            
              
              <a class="source" href="utils.html">
                utils.py
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>leads.py</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">import</span> time
<span class="keyword">from</span> base <span class="keyword">import</span> BaseClient
<span class="keyword">import</span> logging_helper</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>from pprint import pprint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 


LEADS_API_VERSION = <span class="string">'1'</span>

<span class="function"><span class="keyword">def</span> <span class="title">list_to_dict_with_python_case_keys</span><span class="params">(list_)</span>:</span>
    d = {}
    <span class="keyword">for</span> item <span class="keyword">in</span> list_:
        d[item] = item
        <span class="keyword">if</span> item.lower() != item:
            python_variant = item[<span class="number">0</span>].lower() + <span class="string">''</span>.join([c <span class="keyword">if</span> c.lower()==c <span class="keyword">else</span> <span class="string">'_%s'</span>%c.lower() <span class="keyword">for</span> c <span class="keyword">in</span> item[<span class="number">1</span>:]])
            d[python_variant] = item
    <span class="keyword">return</span> d

SORT_OPTIONS = [
    <span class="string">'firstName'</span>,
    <span class="string">'lastName'</span>,
    <span class="string">'email'</span>,
    <span class="string">'address'</span>,
    <span class="string">'phone'</span>,
    <span class="string">'insertedAt'</span>,
    <span class="string">'fce.convertDate'</span>,
    <span class="string">'lce.convertDate'</span>,
    <span class="string">'lastModifiedAt'</span>,
    <span class="string">'closedAt'</span>]
SORT_OPTIONS_DICT = list_to_dict_with_python_case_keys(SORT_OPTIONS)
TIME_PIVOT_OPTIONS = [
    <span class="string">'insertedAt'</span>,
    <span class="string">'firstConvertedAt'</span>,
    <span class="string">'lastConvertedAt'</span>,
    <span class="string">'lastModifiedAt'</span>,
    <span class="string">'closedAt'</span>]
TIME_PIVOT_OPTIONS_DICT = list_to_dict_with_python_case_keys(TIME_PIVOT_OPTIONS)
SEARCH_OPTIONS = [
    <span class="string">'search'</span>,
    <span class="string">'sort'</span>, 
    <span class="string">'dir'</span>,
    <span class="string">'max'</span>,
    <span class="string">'offset'</span>,
    <span class="string">'startTime'</span>,
    <span class="string">'stopTime'</span>,
    <span class="string">'timePivot'</span>,
    <span class="string">'excludeConversionEvents'</span>,
    <span class="string">'emailOptOut'</span>,
    <span class="string">'eligibleForEmail'</span>,
    <span class="string">'bounced'</span>,
    <span class="string">'isNotImported'</span>]
SEARCH_OPTIONS_DICT = list_to_dict_with_python_case_keys(SEARCH_OPTIONS)
BOOLEAN_SEARCH_OPTIONS = set([
    <span class="string">'excludeConversionEvents'</span>,
    <span class="string">'emailOptOut'</span>,
    <span class="string">'eligibleForEmail'</span>,
    <span class="string">'bounced'</span>,
    <span class="string">'isNotImported'</span>])

MAX_BATCH=<span class="number">100</span>

<span class="class"><span class="keyword">class</span> <span class="title">LeadsClient</span><span class="params">(BaseClient)</span>:</span>
    <span class="string">"""
    The hapipy Leads client uses the _make_request method to call the API for data.  It returns a python object translated from the json return
    """</span>

    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span>
        super(LeadsClient, self).__init__(*args, **kwargs)
        self.log = logging_helper.get_log(<span class="string">'hapi.leads'</span>)

    <span class="function"><span class="keyword">def</span> <span class="title">camelcase_search_options</span><span class="params">(self, options)</span>:</span>
        <span class="string">"""change all underscored variants back to what the API is expecting"""</span>
        new_options = {}
        <span class="keyword">for</span> key <span class="keyword">in</span> options:
            value = options[key]
            new_key = SEARCH_OPTIONS_DICT.get(key, key)
            <span class="keyword">if</span> new_key == <span class="string">'sort'</span>:
                value = SORT_OPTIONS_DICT.get(value, value)
            <span class="keyword">elif</span> new_key == <span class="string">'timePivot'</span>:
                value = TIME_PIVOT_OPTIONS_DICT.get(value, value)
            <span class="keyword">elif</span> new_key <span class="keyword">in</span> BOOLEAN_SEARCH_OPTIONS:
                value = str(value).lower()
            new_options[new_key] = value
        <span class="keyword">return</span> new_options

    <span class="function"><span class="keyword">def</span> <span class="title">_get_path</span><span class="params">(self, subpath)</span>:</span>
        <span class="keyword">return</span> <span class="string">'leads/v%s/%s'</span> % (self.options.get(<span class="string">'version'</span>) <span class="keyword">or</span> LEADS_API_VERSION, subpath)
  
    <span class="function"><span class="keyword">def</span> <span class="title">get_lead</span><span class="params">(self, guid, **options)</span>:</span>
        <span class="keyword">return</span> self.get_leads(guid, **options)[<span class="number">0</span>]

    <span class="function"><span class="keyword">def</span> <span class="title">get_leads</span><span class="params">(self, *guids, **options)</span>:</span>
        <span class="string">"""Supports all the search parameters in the API as well as python underscored variants"""</span>
        original_options = options
        options = self.camelcase_search_options(options.copy())
        params = {}
        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(guids)):
            params[<span class="string">'guids[%s]'</span>%i] = guids[i]
        <span class="keyword">for</span> k <span class="keyword">in</span> options.keys():
            <span class="keyword">if</span> k <span class="keyword">in</span> SEARCH_OPTIONS:
                params[k] = options[k]
                <span class="keyword">del</span> options[k]
        leads = self._call(<span class="string">'list/'</span>, params, **options)
        self.log.info(<span class="string">"retrieved %s leads through API ( %soptions=%s )"</span> % 
                (len(leads), guids <span class="keyword">and</span> <span class="string">'guids=%s, '</span>%guids <span class="keyword">or</span> <span class="string">''</span>, original_options))
        <span class="keyword">return</span> leads

    <span class="function"><span class="keyword">def</span> <span class="title">retrieve_lead</span><span class="params">(self, *guid, **options)</span>:</span>
        cur_guid = guid <span class="keyword">or</span> <span class="string">''</span> 
        params = {}
        <span class="keyword">for</span> key <span class="keyword">in</span> options:
            params[key] = options[key]
        <span class="string">""" Set guid to -1 as default for not finding a user """</span>
        lead = {<span class="string">'guid'</span> : <span class="string">'-1'</span>}
        <span class="string">""" wrap lead call so that it doesn't error out when not finding a lead """</span>
        <span class="keyword">try</span>:
            lead = self._call(<span class="string">'lead/%s'</span> % cur_guid, params, **options)
        <span class="keyword">except</span>:
            <span class="string">""" no lead here """</span>
        <span class="keyword">return</span> lead


    <span class="function"><span class="keyword">def</span> <span class="title">update_lead</span><span class="params">(self, guid, update_data=None, **options)</span>:</span>
        update_data = update_data <span class="keyword">or</span> {}
        update_data[<span class="string">'guid'</span>] = guid
        <span class="keyword">return</span> self._call(<span class="string">'lead/%s/'</span> % guid, data=update_data, method=<span class="string">'PUT'</span>, **options)
    
    <span class="function"><span class="keyword">def</span> <span class="title">get_webhook</span><span class="params">(self, **options)</span>:</span>  <span class="comment">#WTF are these 2 methods for?</span>
        <span class="keyword">return</span> self._call(<span class="string">'callback-url'</span>, **options)
    
    <span class="function"><span class="keyword">def</span> <span class="title">register_webhook</span><span class="params">(self, url, **options)</span>:</span>
        <span class="keyword">return</span> self._call(<span class="string">'callback-url'</span>, params={<span class="string">'url'</span>: url}, data={<span class="string">'url'</span>: url}, method=<span class="string">'POST'</span>, **options)
    
    <span class="function"><span class="keyword">def</span> <span class="title">close_lead</span><span class="params">(self, guid, close_time=None, **options)</span>:</span>
        <span class="keyword">return</span> self.update_lead(guid, {<span class="string">'closedAt'</span>: close_time <span class="keyword">or</span> int(time.time()*<span class="number">1000</span>)}, **options)
    
    <span class="function"><span class="keyword">def</span> <span class="title">open_lead</span><span class="params">(self, guid, **options)</span>:</span>
        self.update_lead(guid, {<span class="string">'closedAt'</span>: <span class="string">''</span>}, **options)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
